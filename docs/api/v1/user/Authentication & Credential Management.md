# Authentication & Credential Management

This document provides information on how to authenticate against the API, and how to perform basic credential management.

## Authentication

This section outlines the specifics of API authentication and general credential management.

The API takes a token based approach to authentication - in exchange for providing the user's identity via a username, and password (and OTP code if necessary), the API will provide a set of tokens that can be used to authenticate the user for all future sessions.

For more information about _how_ to Authenticate, see the [Authentication.md](../../Authentication.md) document in the root of the API documentation.

By default, the tokens returned are valid for 15 minutes. Additional actions outside of that time window require either re-authentication, or token regeneration.

> The token expiration timer can be adjusted by setting the `TOKEN_EXPIRATION_TIME` constant in `app/models/Token` to any `strtotime` value. The default value is `+15 minutes`.

## Deauthentication

Users can de-authenticate from their account by sending an authenticated `DELETE` request to `/api/v1/user/authenticate`.

```
Headers:
    X-Date
    Authorization

DELETE /api/v1/user/authenticate
```

Assuming you are authenticated properly, an HTTP 200 status will be returned with the following response.

```json
{
    "data": true,
    "status": 200
}
```

## Renewing authentication tokens

Authentication tokens can be refresh by sending an authenticated `POST` request to `/api/v1/user/refresh` with `refresh_token` provided by the initial authentication. 

> Token refreshing is the preferred method of renewing authentication tokens, as it does not require the username and password.

```
Headers:
    X-Date
    Authorization

POST /api/v1/user/refresh
{
    "refresh_token": "<refresh_token>"
}
``` 

If successful, a new set of tokens will be generated with an HTTP 200 status code.

```json
{
    "data": {
        "access_token": "<access_token>",
        "refresh_token": "<refresh_token>",
        "ikm": "<base64_ikm>",
        "expires_at": int_expiration_time
    },
    "status": 200
}
```

If the refresh token is invalid, an HTTP 200 status code will be returned with the `data` attribute set to `false`.

```json
{
    "data": false,
    "status": 200
}
```

## One time passwords

To further secure user accounts, two factor authentication can be enabled for the account. Two factor authentication is managed through Time-based One Time Passwords (TOTP), which can be added two any standard TOTP manager such as Authy, Google Authenticator, or Microsoft Authenticator.

### Enabling OTP

Two factor authentication is a two step process.

The first step is to generate a provisioning code, which is achieved by sending a empty authenticated `POST` request to `/api/v1/user/otp`.

```
Headers:
    X-Date
    Authorization

POST /api/v1/user/otp
```

If OTP is already enabled, an HTTP 400 status code will be returned.
```json
{
    "data": null,
    "status": 400
}
```

Otherwise, a provisioning code will be returned. This provisioning code can be loaded into your preferred authenticator app.

```json
{
    "data": {
        "provisioning_code": "<provisioning_code>"
    },
    "status": 200
}
```

> Note at this point two factor authentication _is *not*_ enabled for your account.

The second step is to provide the API with a verification code to ensure your authenticator app is properly configured. Two factor authentication can be enabled by retrieving the code generated by your authenticator app, and sending an authenticated `POST` request with the code to `/api/v1/user/otp`.

```
Headers:
    X-Date
    Authorization

POST /api/v1/user/otp
{
    "code": "<string_otp_code>"
}
```

> Note that the OTP code must be a string, not an integer.

If the OTP code is valid, an HTTP 200 status code will be return with the `data` attribute set to `true`. If the OTP verification code is not valid, the `data` attribute will be set to `false`, and you should either a) resubmit with a new verification code, or generate a new provisioning code by sending an empty authenticated `POST` request to `/api/v1/user/otp`.

```json
{
    "data": true|false,
    "status": 200
}
```

### Disabling OTP

Two factor authentication can be disabled by sending an authenticate `DELETE` request to `/api/v1/user/otp` containing a code provided by your authenticator app.


```
Headers:
    X-Date
    Authorization

DELETE /api/v1/user/otp
{
    "code": "<string_otp_code>"
}
```

If the code is valid, two factor authentication will be disabled for the account, and the following response will be provided.

```json
{
    "data": true,
    "status": 200
}
```

If OTP is not enabled, an HTTP 400 status code will be returned.

```json
{
    "data": null,
    "status": 400
}
```

If an invalid verification code is provided, the `data` attribute will be set to false.

```json
{
    "data": false,
    "status": 200
}
```

# Credential management

This section outlines the various credential management API endpoints available.

## Password reset

Passwords can be reset for both authenticated and unauthenticated users. The password reset flow has two steps, an init step that will send a short lived token to the email address belonging to the user, and a reset step that will allow the user to reset the password associate to the account.

### Initiating a password reset

For authenticated users, the reset flow can be initiated by sending an authenticated `POST` request to `/api/v1/user/reset_password`.

```
Headers:
    X-Date
    Authorization

POST /api/v1/user/reset_password
```

For unauthenticated users, the reset flow can be initiated including the email address belonging to the user in the request body.

```
Headers:
    X-Date
    Authorization

POST /api/v1/user/reset_password
{
    "email": "<email_of_user>"
}
```

If the email is not provided, an HTTP 400 error message will be returned, otherwise an HTTP 200 status code will be returned with the following response.

```json
{
    "data": true,
    "status": 200
}
```

> Note that to prevent exposure of user information, this endpoint will always return this status code, regardless of whether a user with that email address actually exists in the system.

### Changing the password

If the user exists, an email will be sent to the user containing a short-lived password reset token. The token is bonded to the user account, if that user exists, and is valid for 4 hours. Any attept to use the token outside of that time frame will result in an API error.

> The reset token is valid for 4 hours, but can be adjusted by setting the `EXPIRY_TIME` constant in `app/forms/ResetPassword` to any `strtotime` valid. The default value is `+4 hours`.

The password can be reset by sending a `POST` request to `/api/v1/user/reset_password` with the reset token set as a `GET` query parameter, the user's current password, and the new password in the request body.

```
Headers:
    X-Date
    Authorization

POST /api/v1/user/reset_password?reset_token=<reset_token_sent_to_email>
{
    "password": "<new_user_password>",
    "password_verify": "<new_user_password_again>",
}
```

> Note that if the account is protected with two factor authentication, an additional request parameter `otp` is required, and must be a valid OTP code belonging to the user.

If any of the values listed are invalid, or do not pass validation rules, an HTTP 400 status code will be returned with the standard error response, otherwise an HTTP 200 status code will be returned.

```json
{
    "data": true,
    "status": 200
}
```

> Note that if you have enabled OTP on your account, and you forget both your password _and_ your OTP code you will be locked out of your account.

## Authenticated password reset

For convenience purposes, `yii2-api` comes with a second password reset flow suitable for authenticated users who possess both their old password (and their OTP code if necessary). This flow is suitable for authenticated users when you want to perform local validation, rather than forcing them to check their email for a one time token.

> Note that for un-authenticated users you will still need to use the tokenized format outlined above. Additional, note that both flows can be used concurrently.

To enable this flow, add the following action to your `actions()` method within your controller, and make the action required within your authenticator behavior.

```php
public function actions()
{
    return [
        'reset_password_authenticated' => [
            'class' => 'yrc\api\actions\ResetPasswordAction',
            'scenario' => ResetPasswordAction::SCENARIO_AUTHENTICATED
        ]
    ]
}

public function behaviors()
{
    $behaviors = parent::behaviors();

    $behaviors['authenticator'] = [
        // [...]
        'only'      => ['reset_password_authenticated'],
        // [...]
    ];

    return $behaviors;
}
```

The user's password can then be reset by sending an authenticated `POST` request with the following payload:

```json
Headers:
    X-Date
    Authorization

POST /api/v1/user/reset_password_authenticated
{
    "old_password": "<users_current_password>",
    "password": "<new_user_password>",
    "password_verify": "<new_user_password_again>",
    // "otp": "<otp_code_if_required>"
}
```

> Note that if the two-factor authentication is enabled for the account, you'll need to send the OTP code along with the payload.
If any of the values listed are invalid, or do not pass validation rules, an HTTP 400 status code will be returned with the standard error response, otherwise an HTTP 200 status code will be returned.

```json
{
    "data": true,
    "status": 200
}
```

> Feel free to `yrc\api\actions\ResetPasswordAction` with a custom implementation if you want both workflows available on the same endpoint.

## Changing email address

The email address associated to an account can be changed by sending an authenticated `POST` requested to `/api/v1/user/change_email` with the following payload.

```
Headers:
    X-Date
    Authorization

POST /api/v1/user/change_email
{
    "email": "<new_email_address>",
    "password": "<current_password>"
}
```

> Note that the email must be a valid email and must not be in use by another user.

If the `POST` request body is valid, an HTTP 200 status code will be returned.

```json
{
    "data": true,
    "status": 200
}
```

If the current password is invalid, or any of the request parameters are missing, an HTTP 400 status code will be returned.

```json
{
    "data": null,
    "status": 400
}
```

> Note that both the new email and the old email will receive a notice that the email address has been changed.
